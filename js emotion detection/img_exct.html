<!DOCTYPE html>

<html lang="en">
  <head runat="server">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="style.css" rel="stylesheet" />
    <title>Document</title>
  </head>
  <body>
    <body style="text-align: center">
      <video id="video" width="320" height="240" autoplay></video>

      <button id="btnStart">Film</button>
      <button id="btnPhoto">Take a picture</button>

      <canvas id="canvas" width="320" height="240"></canvas>

      <br />
      <br />
      <br />
      <br />

      <button onclick="javascript:UploadPic();return false;">Save</button>
    </body>
    <script>
      window.onload = function () {
        navigator.getUserMedia =
          navigator.getUserMedia ||
          navigator.webkitGetUserMedia ||
          navigator.mozGetUserMedia ||
          navigator.msGetUserMedia;

        //picture
        var canvas = document.getElementById("canvas"),
          context = canvas.getContext("2d"),
          //film area
          video = document.getElementById("video"),
          //buttons
          btnStart = document.getElementById("btnStart"),
          btnPhoto = document.getElementById("btnPhoto"),
          //video and audio
          videoObj = {
            video: true,
            audio: false,
          };

        //begin film
        btnStart.addEventListener("click", function () {
          var localMediaStream;

          if (navigator.getUserMedia) {
            navigator.getUserMedia(
              videoObj,
              function (stream) {
                video.src = navigator.webkitGetUserMedia
                  ? window.webkitURL.createObjectURL(stream)
                  : stream;
                localMediaStream = stream;

                if (navigator.mozGetUserMedia) {
                  video.mozSrcObject = stream;
                }
              },
              function (error) {
                console.error("Video capture error: ", error.code);
              }
            );

            //capture image button
            btnPhoto.addEventListener("click", function () {
              context.drawImage(video, 0, 0, 320, 240);
            });
          }
        });
      };

      //Upload da imagem
      function UploadPic() {
        //Converte a imagem em base64
        var Pic = document.getElementById("canvas").toDataURL("image/jpg");
        Pic = Pic.replace(/^data:image\/(png|jpg);base64,/, "");

        //Envia a imagem em base64 para o server (pasta local)
        $.ajax({
          type: "POST",
          url: "Save_Picture.aspx/UploadPic",
          data: '{ "imageData" : "' + Pic + '" }',
          contentType: "application/json; charset=utf-8",
          dataType: "json",
          success: function (msg) {
            alert("Done, Picture Uploaded.");
          },
        });
      }
    </script>
  </body>
</html>
